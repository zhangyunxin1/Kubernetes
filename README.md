# Kubernetes
Kubernetes学习
## 一、准备
1. 一台Ubuntu16.04，已经安装docker。
2. 修改 Docker Cgroup Driver 为 systemd（参考：https://blog.csdn.net/mengting2040/article/details/111690586）
3. 开启Docker使用http代理，不然镜像拉不下来（参考：https://docs.docker.com/config/daemon/systemd/）
4. 关闭swap系统分区，Kubernetes不支持swap分区。swap分区临时关闭指令swapoff -a，通过命令free查看swap分区是否关闭。
## 二、安装kubeadm，kubelet和kubectl
```
sudo apt-get update && sudo apt-get install -y apt-transport-https curl
curl -s https://packages.cloud.google.com/apt/doc/apt-key.gpg | sudo apt-key add -
cat <<EOF | sudo tee /etc/apt/sources.list.d/kubernetes.list
deb https://apt.kubernetes.io/ kubernetes-xenial main
EOF
sudo apt-get update
sudo apt-get install -y kubelet kubeadm kubectl
sudo apt-mark hold kubelet kubeadm kubectl
```
- `注意：`curl -s https://packages.cloud.google.com/apt/doc/apt-key.gpg | sudo apt-key add -需要使用代理，例如
```
curl -s -x http://proxy_ip:proxy_port https://packages.cloud.google.com/apt/doc/apt-key.gpg | sudo apt-key add -
```
## 三、创建单主机Kubernetes集群
### 3.1 初始化主机
```
sudo kubeadm init --pod-network-cidr=192.168.0.0/16
```
- `注意：`如果您的网络中已经使用了192.168.0.0/16，则必须选择其他Pod网络CIDR，以替换上述命令中的192.168.0.0/16。--pod-network-cidr=192.168.0.0/16参数是后面我安装Calico容器网络接口 （CNI）需要。

- kubeadm init首先运行一系列预检查，以确保机器已准备好运行Kubernetes。这些预检查会显示警告并在错误时退出。kubeadm init 然后下载并安装集群控制平面组件。这可能会需要几分钟。完成后，您应该看到：
```
Your Kubernetes control-plane has initialized successfully!

To start using your cluster, you need to run the following as a regular user:

  mkdir -p $HOME/.kube
  sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
  sudo chown $(id -u):$(id -g) $HOME/.kube/config

You should now deploy a Pod network to the cluster.
Run "kubectl apply -f [podnetwork].yaml" with one of the options listed at:
  /docs/concepts/cluster-administration/addons/

You can now join any number of machines by running the following on each node
as root:

kubeadm join <control-plane-host>:<control-plane-port> --token <token> --discovery-token-ca-cert-hash sha256:<hash>
```
- 要再次运行kubeadm init，必须首先拆除集群。
### 3.2 执行以下命令来配置kubectl（由kubeadm init返回）。
```
mkdir -p $HOME/.kube
sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
sudo chown $(id -u):$(id -g) $HOME/.kube/config
```
## 四、安装Pod网络附加组件
- 您必须部署一个 容器网络接口 （CNI）基于Pod的网络插件，以便您的Pod可以相互通信。在安装网络之前，群集DNS（CoreDNS）将不会启动。
### 4.1 我选择使用Calico作为容器网络接口 （CNI），请参考
- 安装Calco网络和网络策略以进行本地部署 [点击此处](https://docs.projectcalico.org/getting-started/kubernetes/self-managed-onprem/onpremises)
### 4.2 我选择的是‘使用Kubernetes API数据存储（不超过50个节点）安装Calico’
- 下载Kubernetes API数据存储区的Calico网络清单。
```
curl https://docs.projectcalico.org/manifests/calico.yaml -O
```
- 如果您使用的是pod CIDR `192.168.0.0/16`，请跳至下一步。如果您在kubeadm上使用其他Pod CIDR，则无需进行任何更改-Calico将根据正在运行的配置自动检测CIDR。对于其他平台，请确保在清单中取消注释CALICO_IPV4POOL_CIDR变量，并将其设置为与所选Pod CIDR相同的值。
- 使用以下命令应用清单。
```
kubectl apply -f calico.yaml
```
- 每个群集只能安装一个Pod网络。

- 安装Pod网络后，您可以通过检查CoreDNS Pod是否Running在中来确认其正常工作`kubectl get pods --all-namespaces`。而且，一旦CoreDNS Pod启用并运行，您就可以通过加入节点来继续。这可能需要一段时间因为要下载calico镜像。
 ### 4.3 检查CoreDNS Pod状态一直为CrashLoopBackOff
 - 通过命令`journalctl -xefu kubelet`查看日志，发送是启动容器失败。
 - 通过命令`docker logs 容器id`查看日志，发现：
 ```
 plugin/loop: Loop (127.0.0.1:55953 -> :1053) detected for zone ".", see https://coredns.io/plugins/loop#troubleshooting. 
 Query: "HINFO 4547991504243258144.3688648895315093531."
 ```
 - 故障排除
 当CoreDNS日志包含该消息时Loop ... detected ...，这意味着loop检测插件已在上游DNS服务器之一中检测到无限转发循环。解决方法就是将主机环境中的127.0.0.1主机ip循环地址删除即可。参考：[CoreDNS循环故障](https://coredns.io/plugins/loop/#troubleshooting)。
 
	找到 /etc/resolv.conf 里面的文件
	 ```
	 # Dynamic resolv.conf(5) file for glibc resolver(3) generated by resolvconf(8)
	# DO NOT EDIT THIS FILE BY HAND -- YOUR CHANGES WILL BE OVERWRITTEN
	nameserver 127.0.1.1
	  ```
	 发现nameserver 127.0.1.1是指向本地，修改文件为
 	  ```
	 # Dynamic resolv.conf(5) file for glibc resolver(3) generated by resolvconf(8)
	# DO NOT EDIT THIS FILE BY HAND -- YOUR CHANGES WILL BE OVERWRITTEN
	# nameserver 127.0.1.1
	nameserver 8.8.8.8
	nameserver 8.8.4.4
 	  ```
 	刷新更改并重新启动Docker
 	```
 	sudo systemctl daemon-reload
	sudo systemctl restart docker
 	```
 	等待容器启动，通过`kubectl get pods --all-namespaces`检查CoreDNS Pod状态，kubectl get nodes查看节点状态为Ready。
 	![在这里插入图片描述](https://img-blog.csdnimg.cn/20201229161747440.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L21lbmd0aW5nMjA0MA==,size_16,color_FFFFFF,t_70)
## 五、拆除Kubernetes集群
- 如果需要再次运行kubeadm init，必须首先拆除集群。
### 5.1 删除节点
```
kubectl drain <node name> --delete-local-data --force --ignore-daemonsets
```
```
kubectl delete node <node name>
```
### 5.2 重置kubeadm状态
```
kubeadm reset
```
